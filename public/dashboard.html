<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob Live API Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');
        :root {
            --ink: #0b0f19;
            --panel: #0f172a;
            --panel-2: #111827;
            --stroke: #263041;
            --accent: #22c55e;
            --accent-2: #86efac;
            --accent-3: #10b981;
        }
        body { font-family: 'Space Grotesk', sans-serif; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: 'IBM Plex Mono', monospace; }
        .status-pill { border: 1px solid var(--stroke); background: rgba(15, 23, 42, 0.8); padding: 6px 10px; border-radius: 10px; font-size: 12px; }
        .toast { border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 12px; font-size: 12px; margin-bottom: 8px; backdrop-filter: blur(6px); }
        .toast.success { background: rgba(6, 46, 30, 0.75); border-color: #14532d; color: #86efac; }
        .toast.error { background: rgba(63, 10, 10, 0.75); border-color: #7f1d1d; color: #fca5a5; }
        .toast.info { background: rgba(15, 23, 42, 0.75); border-color: #1e293b; color: #cbd5e1; }
        .glass { background: rgba(15, 23, 42, 0.75); border: 1px solid var(--stroke); }
        .glow-outline { box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.28), 0 10px 30px rgba(34, 197, 94, 0.18); }
        .soft-grid {
            background-image:
                radial-gradient(circle at 15% 20%, rgba(34, 197, 94, 0.14), transparent 40%),
                radial-gradient(circle at 85% 10%, rgba(16, 185, 129, 0.12), transparent 35%),
                radial-gradient(circle at 70% 80%, rgba(134, 239, 172, 0.12), transparent 40%),
                linear-gradient(120deg, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.98));
        }
        .fade-in { animation: fadeInUp 600ms ease both; }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="soft-grid text-gray-100 min-h-screen p-6">
    <div id="toastArea" class="fixed right-4 top-4 w-80 z-50"></div>

    <div class="max-w-6xl mx-auto flex flex-col gap-4 mb-8 border-b border-slate-800/70 pb-4 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-emerald-300 tracking-tight">Live Generated Backend</h1>
                <p class="text-slate-400 text-sm">Turn your prompt into live APIs, instantly.</p>
            </div>
            <a href="/" class="text-xs text-slate-400 hover:text-white">Back to Builder</a>
        </div>
        <div id="statusStrip" class="flex flex-wrap items-center gap-2 text-xs">
            <div class="status-pill">Status: <span id="statusConnected" class="text-red-300 font-bold">Disconnected</span></div>
            <div class="status-pill">Type: <span id="statusType" class="text-white">--</span></div>
            <div class="status-pill">TTL: <span id="statusTtl" class="text-yellow-300 font-bold">--:--:--</span></div>
            <div class="status-pill">Health: <span id="statusHealth" class="text-gray-300">Waiting</span></div>
            <div class="status-pill">System: <span id="statusSystem" class="text-gray-300">Checking</span></div>
        </div>

        <div class="flex flex-wrap gap-2">
            <input type="text" id="serviceId" placeholder="Service ID" class="glass p-2 rounded text-white outline-none focus:border-emerald-500">
            <input type="text" id="serviceToken" placeholder="Service Token" class="glass p-2 rounded text-white outline-none focus:border-emerald-500 min-w-[220px]">
            <button onclick="connectService()" class="bg-emerald-600 px-4 py-2 rounded font-bold hover:bg-emerald-500">Connect</button>
            <select id="resourceSelect" class="glass p-2 rounded text-white outline-none focus:border-emerald-500"></select>
            <button onclick="refreshPanels()" class="bg-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-600">Refresh</button>
        </div>

        <div id="metaBox" class="text-xs text-slate-400"></div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">
        <div class="glass glow-outline p-6 rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-xl font-bold text-emerald-300">Endpoints</h2>
                    <p class="text-xs text-slate-400">Copy these into your frontend.</p>
                </div>
                <span id="copyStatus" class="text-xs text-slate-400"></span>
            </div>
            <div id="endpointsList" class="space-y-2 text-xs">
                <div class="text-slate-500">Connect a service to see endpoints.</div>
            </div>
        </div>

        <div class="glass glow-outline p-6 rounded-lg">
            <div class="mb-4">
                <h2 class="text-xl font-bold text-emerald-300">How to Use in Frontend</h2>
                <p class="text-xs text-slate-400">Beginner-friendly steps + examples.</p>
            </div>

            <div class="grid grid-cols-1 gap-3 text-xs">
                <div class="bg-slate-950/80 border border-slate-800 rounded p-3">
                    <div class="text-slate-400 mb-1">Step 1: Base URL</div>
                    <div id="frontendBase" class="text-white break-words">https://your-domain.com/generated/{serviceId}</div>
                </div>
                <div class="bg-slate-950/80 border border-slate-800 rounded p-3">
                    <div class="text-slate-400 mb-1">Step 2: Token Header</div>
                    <div id="frontendToken" class="text-white break-words">x-service-token: {token}</div>
                </div>
                <div class="bg-slate-950/80 border border-slate-800 rounded p-3">
                    <div class="text-slate-400 mb-1">Step 3: Create Example</div>
                    <pre id="frontendCreate" class="text-emerald-300"></pre>
                </div>
                <div class="bg-slate-950/80 border border-slate-800 rounded p-3">
                    <div class="text-slate-400 mb-1">Step 4: List Example</div>
                    <pre id="frontendList" class="text-emerald-300"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentServiceId = null;
        let currentToken = '';
        let meta = null;
        let copyTimer = null;
        let isConnected = false;
        let ttlInterval = null;
        let currentExpiresAt = null;
        let systemHealthTimer = null;

        const params = new URLSearchParams(window.location.search);
        const initialId = params.get('id');
        const initialToken = params.get('token');
        if (initialId) {
            document.getElementById('serviceId').value = initialId;
        }
        if (initialToken) {
            document.getElementById('serviceToken').value = initialToken;
        }
        if (initialId && initialToken) {
            connectService();
        }

        function setSystemStatus(label, className = 'text-gray-300') {
            const el = document.getElementById('statusSystem');
            el.textContent = label;
            el.className = className;
        }

        async function loadSystemHealth() {
            try {
                const res = await fetch('/health');
                const data = await res.json();
                if (!res.ok || !data.ok) {
                    setSystemStatus('Degraded', 'text-yellow-300 font-bold');
                    return;
                }
                if (data.db === 'connected' && (data.redis === 'connected' || data.redis === 'disabled')) {
                    setSystemStatus('Healthy', 'text-emerald-300 font-bold');
                    return;
                }
                setSystemStatus('Partial', 'text-yellow-300 font-bold');
            } catch {
                setSystemStatus('Offline', 'text-red-300 font-bold');
            }
        }

        function showToast(message, type = 'info') {
            const area = document.getElementById('toastArea');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            area.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 2600);
        }

        function formatDuration(ms) {
            const safe = Math.max(0, Math.floor(ms / 1000));
            const hours = Math.floor(safe / 3600);
            const minutes = Math.floor((safe % 3600) / 60);
            const seconds = safe % 60;
            return [hours, minutes, seconds].map((v) => String(v).padStart(2, '0')).join(':');
        }

        function stopCountdown() {
            if (ttlInterval) {
                clearInterval(ttlInterval);
                ttlInterval = null;
            }
        }

        function startCountdown(expiresAt) {
            stopCountdown();
            currentExpiresAt = expiresAt ? new Date(expiresAt).getTime() : null;

            if (!currentExpiresAt || Number.isNaN(currentExpiresAt)) {
                document.getElementById('statusTtl').textContent = '--:--:--';
                return;
            }

            const tick = () => {
                const remainingMs = currentExpiresAt - Date.now();
                const remainingText = formatDuration(remainingMs);
                document.getElementById('statusTtl').textContent = remainingText;
                if (remainingMs <= 0) {
                    stopCountdown();
                    disconnectState('Service expired or destroyed');
                }
            };

            tick();
            ttlInterval = setInterval(tick, 1000);
        }

        async function connectService() {
            const serviceId = document.getElementById('serviceId').value.trim();
            const token = document.getElementById('serviceToken').value.trim();
            if (!serviceId) {
                showToast('Enter a service ID first', 'error');
                return;
            }
            if (!token) {
                showToast('Enter service token', 'error');
                return;
            }

            const res = await fetch(`/generated/${serviceId}/meta`, {
                headers: { 'x-service-token': token }
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
                disconnectState(data.message || data.error || 'Service unavailable or expired');
                showToast(data.message || data.error || 'Failed to load generated service metadata', 'error');
                return;
            }

            currentServiceId = serviceId;
            currentToken = token;
            meta = data;
            isConnected = true;

            const resourceSelect = document.getElementById('resourceSelect');
            resourceSelect.innerHTML = '';
            data.resources.forEach((resource) => {
                const option = document.createElement('option');
                option.value = resource.key;
                option.textContent = `${resource.key} (${resource.fields.length} fields)`;
                resourceSelect.appendChild(option);
            });

            const origin = window.location.origin;
            document.getElementById('metaBox').innerHTML = `
                <div>Service: <span class="text-white">${data.name}</span></div>
                <div>Type: <span class="text-white">${data.serviceType}</span></div>
                <div>Description: <span class="text-white">${data.description}</span></div>
                <div>Expires At: <span class="text-white">${new Date(data.expiresAt).toLocaleString()}</span></div>
                <div>Base API: <span class="text-white">${origin}/generated/${serviceId}</span></div>
                <div>Token: <span class="text-white">${token}</span></div>
            `;
            document.getElementById('statusConnected').textContent = 'Connected';
            document.getElementById('statusConnected').className = 'text-emerald-300 font-bold';
            document.getElementById('statusType').textContent = data.serviceType || '--';
            document.getElementById('statusHealth').textContent = 'Healthy';
            document.getElementById('statusHealth').className = 'text-emerald-300';

            startCountdown(data.expiresAt);
            refreshPanels();
            showToast('Service connected', 'success');
        }

        function disconnectState(reason) {
            stopCountdown();
            currentExpiresAt = null;
            currentServiceId = null;
            currentToken = '';
            meta = null;
            isConnected = false;
            document.getElementById('statusConnected').textContent = 'Disconnected';
            document.getElementById('statusConnected').className = 'text-red-300 font-bold';
            document.getElementById('statusType').textContent = '--';
            document.getElementById('statusTtl').textContent = '--:--:--';
            document.getElementById('statusHealth').textContent = 'Unavailable';
            document.getElementById('statusHealth').className = 'text-red-300';
            document.getElementById('resourceSelect').innerHTML = '';
            document.getElementById('metaBox').innerHTML = `<span class="text-red-400">${reason}</span>`;
            document.getElementById('endpointsList').innerHTML = `<div class="text-red-400">${reason}</div>`;
            resetFrontendUsage();
        }

        function getApiContext() {
            const serviceId = document.getElementById('serviceId').value.trim();
            const token = document.getElementById('serviceToken').value.trim();
            const resource = document.getElementById('resourceSelect').value;
            const origin = window.location.origin;
            return { serviceId, token, resource, origin };
        }

        function resetFrontendUsage() {
            document.getElementById('frontendBase').textContent = 'https://your-domain.com/generated/{serviceId}';
            document.getElementById('frontendToken').textContent = 'x-service-token: {token}';
            document.getElementById('frontendCreate').textContent = '# Connect service first';
            document.getElementById('frontendList').textContent = '# Connect service first';
        }

        function renderEndpoints() {
            const { serviceId, token, resource, origin } = getApiContext();
            const list = document.getElementById('endpointsList');
            if (!serviceId || !resource || !token) {
                list.innerHTML = '<div class="text-slate-500">Connect a service to see endpoints.</div>';
                return;
            }

            const base = `${origin}/generated/${serviceId}/${resource}`;
            const metaUrl = `${origin}/generated/${serviceId}/meta`;
            const endpoints = [
                { method: 'GET', label: 'META', url: metaUrl },
                { method: 'GET', label: 'LIST', url: base },
                { method: 'POST', label: 'CREATE', url: base },
                { method: 'GET', label: 'READ', url: `${base}/{id}` },
                { method: 'PUT', label: 'UPDATE', url: `${base}/{id}` },
                { method: 'DELETE', label: 'DELETE', url: `${base}/{id}` }
            ];

            list.innerHTML = endpoints.map((item) => `
                <div class="flex items-center justify-between bg-slate-950/80 border border-slate-800 rounded p-2 gap-2">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-emerald-300 font-bold">${item.method}</span>
                        <span class="px-2 py-0.5 rounded bg-emerald-900/40 text-emerald-200 border border-emerald-800 text-[10px] tracking-wide">${item.label}</span>
                        <span class="text-white break-words">${item.url}</span>
                    </div>
                    <button class="text-emerald-300 hover:text-emerald-200" onclick="copyText('${item.url}')">Copy</button>
                </div>
            `).join('');
        }

        function renderFrontendUsage() {
            const { serviceId, token, resource, origin } = getApiContext();
            if (!serviceId || !resource || !token) {
                resetFrontendUsage();
                return;
            }

            const base = `${origin}/generated/${serviceId}/${resource}`;
            document.getElementById('frontendBase').textContent = `${origin}/generated/${serviceId}`;
            document.getElementById('frontendToken').textContent = `x-service-token: ${token}`;
            document.getElementById('frontendCreate').textContent =
`fetch("${base}", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "x-service-token": "${token}"
  },
  body: JSON.stringify({ name: "example" })
})`;
            document.getElementById('frontendList').textContent =
`fetch("${base}", {
  headers: {
    "x-service-token": "${token}"
  }
})`;
        }

        function refreshPanels() {
            renderEndpoints();
            renderFrontendUsage();
        }

        async function copyText(text) {
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
            } catch {
                const temp = document.createElement('textarea');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
            }
            const status = document.getElementById('copyStatus');
            status.textContent = 'Copied';
            showToast('Copied', 'success');
            clearTimeout(copyTimer);
            copyTimer = setTimeout(() => {
                status.textContent = '';
            }, 1200);
        }

        document.getElementById('resourceSelect').addEventListener('change', refreshPanels);
        document.getElementById('serviceId').addEventListener('input', refreshPanels);
        document.getElementById('serviceToken').addEventListener('input', refreshPanels);
        refreshPanels();

        loadSystemHealth();
        if (systemHealthTimer) clearInterval(systemHealthTimer);
        systemHealthTimer = setInterval(loadSystemHealth, 30000);
    </script>
</body>
</html>
